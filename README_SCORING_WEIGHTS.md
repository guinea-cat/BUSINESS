# 代码质量评分权重分配方案

## 概述

代码质量评分系统采用**100分制**，将代码质量分为5个主要维度，每个维度分配不同的权重，最终得出0-100分的综合评分。

## 评分维度与权重分配

### 总分构成

| 评估维度 | 权重 | 分值 | 说明 |
|---------|------|------|------|
| 静态代码分析（Static Analysis） | 25% | 25分 | Lint工具检查、圈复杂度、代码重复率 |
| 自动化测试指标（Testing Metrics） | 25% | 25分 | 单元测试覆盖率、测试通过率 |
| 代码评审（Code Review） | 20% | 20分 | 设计模式应用、可读性、安全性 |
| 架构与设计评估（Architecture） | 20% | 20分 | 耦合度与内聚性、分层架构、依赖管理 |
| SonarQube质量门禁 | 10% | 10分 | 可靠性、安全性、可维护性评级 |
| **总分** | **100%** | **100分** | |

---

## 1. 静态代码分析（25分）

### 评估内容（参照 demand.md）

- **Lint工具检查**：使用如 ESLint (JS)、Pylint (Python) 或 Checkstyle (Java) 检查是否符合编程规范
- **圈复杂度**：衡量代码逻辑的复杂程度（通常超过 10-15 说明难以测试和维护）
- **代码重复率**：检测重复代码（DRY 原则），重复率过高会增加维护成本

### 评分方法

三个指标等权重计算：

```
Lint得分 = 100 - min(100, Lint问题数量 × 2.0)
圈复杂度得分 = 100 - min(100, 平均圈复杂度 × 5.0)
代码重复率得分 = 100 - 代码重复率 × 100.0

静态代码分析得分 = (Lint得分 + 圈复杂度得分 + 代码重复率得分) / 3.0
静态代码分析加权得分 = 静态代码分析得分 × 0.25
```

### 评分示例

- **Lint问题10个**：Lint得分 = 100 - 20 = 80分
- **平均圈复杂度8**：圈复杂度得分 = 100 - 40 = 60分
- **代码重复率5%**：代码重复率得分 = 100 - 5 = 95分
- **综合得分**：(80 + 60 + 95) / 3 = 78.3分
- **加权得分**：78.3 × 0.25 = **19.6分**

---

## 2. 自动化测试指标（25分）

### 评估内容（参照 demand.md）

- **单元测试覆盖率**：覆盖率低于 60%-70% 说明项目存在较大的回归风险
- **测试通过率**：考察 CI/CD 流水线中测试的稳定性

### 评分方法

测试覆盖率权重70%，测试通过率权重30%：

```
测试指标得分 = 测试覆盖率 × 70.0 + 测试通过率 × 30.0
测试指标加权得分 = 测试指标得分 × 0.25
```

### 评分示例

- **测试覆盖率80%**：80 × 70% = 56分
- **测试通过率100%**：100 × 30% = 30分
- **综合得分**：56 + 30 = 86分
- **加权得分**：86 × 0.25 = **21.5分**

---

## 3. 代码评审（20分）

### 评估内容（参照 demand.md）

- **设计模式应用**：是否过度设计？或者是否完全没有抽象？
- **可读性**：变量命名是否具有描述性？逻辑是否清晰？
- **安全性**：是否存在 SQL 注入风险、硬编码秘钥等安全隐患

### 评分方法

三个维度等权重计算（各33.3%）：

```
设计模式得分 = 0.7（有设计模式应用）或 0.3（无设计模式应用）
可读性得分 = 可读性评分（0-1.0）
安全性得分 = 1.0 - min(1.0, 安全问题数量 × 0.2)

代码评审得分 = 设计模式得分 × 33.3 + 可读性得分 × 33.3 + 安全性得分 × 33.4
代码评审加权得分 = 代码评审得分 × 0.20
```

### 评分示例

- **有设计模式应用**：设计模式得分 = 0.7 × 33.3 = 23.3分
- **可读性评分0.8**：可读性得分 = 0.8 × 33.3 = 26.6分
- **安全问题2个**：安全性得分 = (1.0 - 0.4) × 33.4 = 20.0分
- **综合得分**：23.3 + 26.6 + 20.0 = 69.9分
- **加权得分**：69.9 × 0.20 = **14.0分**

---

## 4. 架构与设计评估（20分）

### 评估内容（参照 demand.md）

- **耦合度与内聚性**：模块之间是否互相关联过深？改动一个地方是否会引起大面积崩溃？
- **分层架构**：业务逻辑是否混在了 UI 层或数据库层中？
- **依赖管理**：项目是否引用了大量过时或有漏洞的第三方库

### 评分方法

耦合度与内聚性合并为一个维度（40%），分层架构（30%），依赖管理（30%）：

```
耦合度与内聚性得分 = (耦合度评分 + 内聚性评分) / 2.0
依赖管理得分 = 依赖健康度 × (1.0 - min(1.0, (过时依赖数量 + 漏洞依赖数量) × 0.1))

架构评估得分 = 耦合度与内聚性得分 × 40.0 + 分层架构得分 × 30.0 + 依赖管理得分 × 30.0
架构评估加权得分 = 架构评估得分 × 0.20
```

### 评分示例

- **耦合度0.7，内聚性0.8**：耦合度与内聚性得分 = (0.7 + 0.8) / 2 × 40 = 30.0分
- **分层架构0.9**：分层架构得分 = 0.9 × 30 = 27.0分
- **依赖健康度0.8，问题依赖3个**：依赖管理得分 = 0.8 × (1.0 - 0.3) × 30 = 16.8分
- **综合得分**：30.0 + 27.0 + 16.8 = 73.8分
- **加权得分**：73.8 × 0.20 = **14.8分**

---

## 5. SonarQube质量门禁（10分）

### 评估内容（参照 demand.md）

SonarQube 通过"可靠性（Bug）、安全性（漏洞）、可维护性（异味）"三个维度给代码打分（A-E 等级）

### 评分方法

三个维度等权重计算（各33.3%）：

| 评级 | 分数 | 说明 |
|------|------|------|
| A | 100分 | 优秀 |
| B | 80分 | 良好 |
| C | 60分 | 中等 |
| D | 40分 | 较差 |
| E | 20分 | 很差 |

```
SonarQube得分 = (可靠性评级分数 + 安全性评级分数 + 可维护性评级分数) / 3.0
SonarQube加权得分 = SonarQube得分 × 0.10
```

### 评分示例

- **可靠性评级B**：80分
- **安全性评级A**：100分
- **可维护性评级B**：80分
- **综合得分**：(80 + 100 + 80) / 3 = 86.7分
- **加权得分**：86.7 × 0.10 = **8.7分**

---

## 综合评分计算

### 最终得分公式

```
总分 = 静态代码分析加权得分 +
       测试指标加权得分 +
       代码评审加权得分 +
       架构评估加权得分 +
       SonarQube加权得分

最终得分 = min(100.0, max(0.0, 总分))
```

### 评分范围

- **最低分**：0分
- **最高分**：100分
- **评分等级**（建议）：
  - 90-100分：优秀（Excellent）
  - 80-89分：良好（Good）
  - 70-79分：中等（Average）
  - 60-69分：及格（Pass）
  - 0-59分：不及格（Fail）

---

## 完整评分示例

### 示例：高质量项目

假设一个项目的各项指标如下：

- **静态代码分析**：
  - Lint问题5个 → Lint得分 = 90分
  - 平均圈复杂度6 → 圈复杂度得分 = 70分
  - 代码重复率3% → 代码重复率得分 = 97分
  - 综合得分 = (90 + 70 + 97) / 3 = 85.7分
  - 加权得分 = 85.7 × 0.25 = **21.4分**

- **测试指标**：
  - 测试覆盖率85%，通过率100%
  - 综合得分 = 85 × 0.7 + 100 × 0.3 = 89.5分
  - 加权得分 = 89.5 × 0.25 = **22.4分**

- **代码评审**：
  - 有设计模式，可读性0.9，安全问题1个
  - 综合得分 = 0.7 × 33.3 + 0.9 × 33.3 + 0.8 × 33.4 = 80.0分
  - 加权得分 = 80.0 × 0.20 = **16.0分**

- **架构评估**：
  - 耦合度0.8，内聚性0.85，分层架构0.9，依赖健康度0.9，问题依赖1个
  - 综合得分 = (0.8+0.85)/2 × 40 + 0.9 × 30 + 0.9 × 0.9 × 30 = 79.5分
  - 加权得分 = 79.5 × 0.20 = **15.9分**

- **SonarQube**：
  - 可靠性A，安全性A，可维护性B
  - 综合得分 = (100 + 100 + 80) / 3 = 93.3分
  - 加权得分 = 93.3 × 0.10 = **9.3分**

**总分** = 21.4 + 22.4 + 16.0 + 15.9 + 9.3 = **85.0分**（良好）

### 示例：低质量项目

假设一个项目的各项指标如下：

- **静态代码分析**：
  - Lint问题30个 → Lint得分 = 40分
  - 平均圈复杂度15 → 圈复杂度得分 = 25分
  - 代码重复率20% → 代码重复率得分 = 80分
  - 综合得分 = (40 + 25 + 80) / 3 = 48.3分
  - 加权得分 = 48.3 × 0.25 = **12.1分**

- **测试指标**：
  - 测试覆盖率30%，通过率80%
  - 综合得分 = 30 × 0.7 + 80 × 0.3 = 45.0分
  - 加权得分 = 45.0 × 0.25 = **11.3分**

- **代码评审**：
  - 无设计模式，可读性0.5，安全问题5个
  - 综合得分 = 0.3 × 33.3 + 0.5 × 33.3 + 0.0 × 33.4 = 26.7分
  - 加权得分 = 26.7 × 0.20 = **5.3分**

- **架构评估**：
  - 耦合度0.4，内聚性0.5，分层架构0.3，依赖健康度0.4，问题依赖10个
  - 综合得分 = (0.4+0.5)/2 × 40 + 0.3 × 30 + 0.4 × 0.0 × 30 = 27.0分
  - 加权得分 = 27.0 × 0.20 = **5.4分**

- **SonarQube**：
  - 可靠性D，安全性E，可维护性E
  - 综合得分 = (40 + 20 + 20) / 3 = 26.7分
  - 加权得分 = 26.7 × 0.10 = **2.7分**

**总分** = 12.1 + 11.3 + 5.3 + 5.4 + 2.7 = **36.8分**（不及格）

---

## 相关文档

- [demand.md](./demand.md) - 代码质量评估需求文档（评分方案的主要参考）
- [README_CODE_QUALITY_RESEARCHER.md](./README_CODE_QUALITY_RESEARCHER.md) - 代码质量研究工具说明
- [README_AI_EVALUATOR.md](./README_AI_EVALUATOR.md) - AI项目评价生成器说明
- [enhanced_code_quality_checker.py](./enhanced_code_quality_checker.py) - 代码质量检查器实现

---

*本文档详细说明了代码质量评分系统的简化权重分配方案，严格按照 demand.md 文档的要求设计，避免重复评估。*
