# 商业计划书 AI 分析系统 - 部署与运行指南~

## 📖 项目概述

**SAGE (Strategic AI for General Evaluation)** 是一个基于多模态 AI 的商业计划书深度分析系统，能够：

- 📄 **文本解析**：从 PDF 中提取完整的文本内容
- 🖼️ **视觉分析**：并发分析最多 50 张图片（图表、架构图、财务数据）
- 🔍 **联网搜索**：自动检索市场数据、竞品信息、融资动态
- 💯 **VC 级评估**：基于 5 维度 10 指标的量化评分模型（总分 100）

系统输出包括 Markdown 研报和结构化 JSON 数据，适用于投资机构、创业团队和商业分析师。

---

## 🛠️ 环境准备

### 1. Python 版本要求

- **推荐版本**：Python 3.8 - 3.11
- **不支持**：Python 3.12+（部分依赖库尚未兼容）

检查 Python 版本：
```bash
python --version
```

### 2. 系统依赖

#### Windows
- 无特殊依赖，确保安装了 [Microsoft Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)（用于 PyMuPDF）

#### macOS
```bash
# 安装 Homebrew（如果尚未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 无特殊依赖，Python 自带环境即可
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt-get update
sudo apt-get install -y python3-pip python3-dev
```

### 3. 安装 Python 依赖

克隆项目后，在项目根目录执行：

```bash
# 创建虚拟环境（推荐）
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

**依赖清单说明**：
- `gradio==4.44.0`：Web 界面框架
- `openai==1.12.0`：LLM 调用（兼容 DeepSeek 和通义千问 VL）
- `pymupdf==1.26.7`：PDF 解析与图片提取
- `httpx==0.27.2`：HTTP 请求库（必须锁定此版本以避免兼容性问题）
- `requests==2.31.0`：Google 搜索 API 调用

---

## 🔑 API 密钥配置

本系统需要 **3 个 API 密钥**，请在 `config.py` 文件中配置：

### 1. DeepSeek API Key（主 LLM 模型）

**用途**：商业分析、赛道识别、VC 评分

**获取方式**：
1. 访问 [DeepSeek 开放平台](https://platform.deepseek.com/)
2. 注册并充值（推荐充值 ¥50，约可分析 100-200 份 BP）
3. 在"API 密钥"页面创建密钥

**配置示例**：
```python
# config.py 第 12 行
LLM_API_KEY = "sk-xxxxxxxxxxxxxxxxxxxxxxxx"
```

**费用参考**：约 ¥0.3-0.8 / 份 BP（取决于内容复杂度）

---

### 2. 通义千问 VL API Key（视觉模型）

**用途**：图片内容理解（图表数据、架构图、产品原型）

**获取方式**：
1. 访问 [阿里云百炼平台](https://bailian.console.aliyun.com/)
2. 开通"模型广场" → 启用 `qwen-vl-plus`
3. 在"API-KEY 管理"中创建密钥

**配置示例**：
```python
# config.py 第 21 行
VISION_API_KEY = "sk-xxxxxxxxxxxxxxxxxxxxxxxx"
```

**费用参考**：¥0.008 / 张图，50 张图约 ¥0.4

**重要提示**：
- 必须确保账户有余额，否则会报 `Arrearage` 错误
- 如果预算有限，可在 `utils.py` 第 95 行将 `[:50]` 改为 `[:10]` 限制图片数量

---

### 3. Serper API Key（Google 搜索）

**用途**：市场数据检索、竞品信息查询、融资动态搜索

**获取方式**：
1. 访问 [Serper.dev](https://serper.dev/)
2. 使用 Google 账号登录
3. 免费套餐提供 2,500 次搜索/月

**配置示例**：
```python
# config.py 第 11 行
SERPER_API_KEY = "xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

**费用参考**：免费额度内每月可分析约 250 份 BP

---

## 📂 项目结构说明

```
BUSINESS/
├── agent.py            # 核心业务逻辑：分析流水线、JSON 生成、兜底逻辑
├── utils.py            # 工具函数：PDF 解析、图片分析（并发）、Google 搜索
├── config.py           # 配置中心：API 密钥、SYSTEM_PROMPT（评分标准）
├── app.py              # Gradio Web 界面：上传 PDF、展示报告
├── requirements.txt    # Python 依赖清单
├── README_BACKEND.md   # 后端技术架构文档
└── 代码运行指南.md     # 本文档
```

### 核心工作流程

```
用户上传 PDF
    ↓
[utils.py] 提取文本 + 图片（最多 50 张）
    ↓
[utils.py] 并发调用通义千问 VL 分析图片（10 线程）
    ↓
[agent.py] 融合文本与视觉信息 → 赛道识别
    ↓
[agent.py] 生成 10 个搜索关键词 → 并发 Google 搜索（5 线程）
    ↓
[agent.py] 深度分析 → 5 维度 10 指标量化评分
    ↓
[app.py] 渲染 Markdown 报告 + JSON 数据
```

---

## 🚀 运行步骤

### 1. 启动 Web 界面

在项目根目录执行：

```bash
python app.py
```

**预期输出**：
```
Running on local URL:  http://127.0.0.1:8081

To create a public link, set `share=True` in `launch()`.
```

### 2. 访问界面

在浏览器中打开：[http://127.0.0.1:8081](http://127.0.0.1:8081)

### 3. 上传 PDF 文件

- 点击"上传商业计划书 (PDF)"按钮
- 选择 PDF 文件（建议大小 < 50 MB）
- 点击"🚀 开始深度分析"按钮

### 4. 查看分析结果

系统会实时显示：
- **Markdown 研报**：包含项目画像、市场分析、竞品对比、VC 评分等
- **JSON 数据**：结构化的评分数据，可用于后续数据分析

---

## ⏱️ 性能参考

| 文件类型 | 页数 | 预计耗时 | 资源消耗 |
|---------|------|---------|---------|
| 纯文字 BP | 10-20 页 | 30-50 秒 | CPU < 10% |
| 图文混合 BP | 20-30 页 | 60-90 秒 | CPU 20-30% |
| 图片型 BP（扫描件） | 30-50 页 | 90-120 秒 | CPU 30-50% |

**影响因素**：
- 图片数量（系统会自动筛选最重要的 50 张）
- 网络速度（视觉 API 和搜索 API 的响应时间）
- API 并发限制（通义千问 VL 默认 10 个线程并发）

---

## 🔧 常见问题排查

### 问题 1：端口 8081 被占用

**错误信息**：
```
OSError: Cannot find empty port in range: 8081-8081
```

**解决方案**：

#### Windows
```powershell
# 查找占用 8081 端口的进程
netstat -ano | findstr :8081

# 强制终止进程（将 PID 替换为实际进程 ID）
taskkill /PID <PID> /F
```

#### macOS/Linux
```bash
# 查找占用 8081 端口的进程
lsof -i :8081

# 强制终止进程
kill -9 <PID>
```

**或者修改端口**：
在 `app.py` 第 77 行修改：
```python
demo.launch(server_port=8082)  # 改为 8082 或其他未占用端口
```

---

### 问题 2：API 连接失败

#### 症状 A：DeepSeek API 报错
```
HTTP Request: POST https://api.deepseek.com/chat/completions "HTTP/1.1 401 Unauthorized"
```

**原因**：API Key 无效或账户余额不足

**解决方案**：
1. 检查 `config.py` 第 12 行的 `LLM_API_KEY` 是否正确
2. 访问 [DeepSeek 控制台](https://platform.deepseek.com/) 查看余额
3. 确保 API Key 格式为 `sk-` 开头的完整密钥

---

#### 症状 B：通义千问 VL 报 `Arrearage` 错误
```
'error': {'message': 'Access denied, please make sure your account is in good standing.', 'type': 'Arrearage'}
```

**原因**：阿里云账户欠费

**解决方案**：
1. 访问 [阿里云充值页面](https://usercenter2.aliyun.com/home) 充值（最低 ¥1）
2. 等待 1-2 分钟后重新运行

**临时绕过方案**（仅限纯文字 BP）：
在 `agent.py` 第 180 行添加：
```python
# 跳过视觉分析（临时方案）
visual_descriptions = ""
# if bp_images:
#     visual_descriptions = utils.describe_visual_elements(self.vision_client, bp_images)
```

---

#### 症状 C：Google 搜索超时
```
requests.exceptions.Timeout: HTTPSConnectionPool(host='google.serper.dev', port=443)
```

**原因**：网络防火墙阻止访问或 API Key 无效

**解决方案**：
1. 检查 `config.py` 第 11 行的 `SERPER_API_KEY`
2. 确保网络可以访问 `google.serper.dev`（可能需要科学上网）
3. 如果无法解决，可临时禁用搜索功能（在 `agent.py` 第 201 行注释掉搜索调用）

---

### 问题 3：图片分析超时

**错误信息**：
```
分析图片 X 失败: Request timed out
```

**原因**：
- 网络波动导致 API 响应慢
- 图片过大（超过 20 MB）

**解决方案**：

#### 方案 1：减少并发线程数
在 `utils.py` 第 227 行修改：
```python
with ThreadPoolExecutor(max_workers=5) as executor:  # 从 10 改为 5
```

#### 方案 2：限制分析图片数量
在 `utils.py` 第 95 行修改：
```python
for img in images_with_size[:20]  # 从 50 改为 20
```

#### 方案 3：增加超时时间
在 `agent.py` 第 36 行修改：
```python
timeout=180.0  # 从 120 改为 180 秒
```

---

### 问题 4：JSON 解析失败

**错误信息**：
```
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
```

**原因**：LLM 返回的内容不是有效的 JSON 格式

**解决方案**：
1. 查看终端输出中的"LLM 原始返回内容"
2. 检查 `config.py` 中的 `SYSTEM_PROMPT` 是否被意外修改
3. 如果 DeepSeek API 响应异常，等待几分钟后重试

---

## 📊 使用示例

### 示例 1：分析"字节跳动今日头条"商业计划书

1. **准备文件**：将 BP 保存为 PDF 格式（例如 `字节商业计划书.pdf`）

2. **启动系统**：
   ```bash
   python app.py
   ```

3. **上传文件**：访问 [http://127.0.0.1:8081](http://127.0.0.1:8081)，上传 PDF

4. **查看日志**（终端会实时输出）：
   ```
   2026-01-27 21:55:42 - INFO - 开启流水线分析（多模态+并发优化），处理文件: 字节商业计划书.pdf
   2026-01-27 21:55:44 - INFO - PDF 解析完成：提取 26 张有效图片，将分析 26 张
   2026-01-27 21:55:45 - INFO - 检测到 26 张有效图片，正在发起并发视觉分析（每批 10 个线程）...
   2026-01-27 21:55:58 - INFO - 并发搜索完成：10/10 个关键词获得结果
   2026-01-27 21:57:45 - INFO - 分析流程圆满完成。
   ```

5. **查看报告**：
   - **Markdown 研报**：包含项目画像、市场规模（千亿级）、竞品对比（腾讯新闻/网易新闻）
   - **JSON 数据**：评分示例
     ```json
     "valuation_model": {
       "total_score": 88,
       "rating": "S",
       "summary": "移动互联网时代现象级产品，推荐算法颠覆传统分发，技术与团队顶配",
       "dimensions": {
         "market": {"score": 19, "sub_scores": {"market_size": 10, "timing_growth": 9}},
         "product": {"score": 22, "sub_scores": {"uniqueness": 14, "moat": 8}},
         "team": {"score": 24, "sub_scores": {"founder_capability": 15, "completeness": 9}}
       }
     }
     ```

---

### 示例 2：快速测试（无视觉分析）

如果 API 余额不足，可临时跳过图片分析：

1. 编辑 `agent.py` 第 180-183 行：
   ```python
   # 临时跳过视觉分析
   visual_descriptions = ""
   # if bp_images:
   #     visual_descriptions = utils.describe_visual_elements(self.vision_client, bp_images)
   ```

2. 重新运行 `python app.py`

3. 上传纯文字型 BP（如 Word 导出的 PDF），系统会跳过图片分析，仅基于文本内容生成报告

---

## 🎯 评分体系说明

系统采用 **5 维度 10 指标**的量化评分模型（总分 100）：

| 维度 | 满分 | 细分指标 | 权重分配 |
|------|------|----------|----------|
| **Market（市场潜力）** | 20 | 市场规模 (10) + 增长时机 (10) | 20% |
| **Product（产品与技术）** | 25 | 创新稀缺性 (15) + 护城河 (10) | 25% |
| **Business Model（商业模式）** | 20 | 盈利能力 (10) + 可扩展性 (10) | 20% |
| **Team（团队竞争力）** | 25 | 创始人特质 (15) + 配置完整性 (10) | 25% |
| **Execution（验证与风险）** | 10 | 业务验证 (5) + 合规风险 (5) | 10% |

**评级标准**：
- **S 级** (90-100 分)：明星项目，强烈推荐
- **A 级** (75-89 分)：优质项目，值得关注
- **B 级** (60-74 分)：中等项目，谨慎观望
- **C 级** (45-59 分)：弱势项目，不建议投资
- **D 级** (<45 分)：严重缺陷，一票否决

每个维度的 `sub_scores` 可追溯具体扣分原因，例如：
- "Team 得分低（12/25）是因为 BP 中未提及核心团队背景（founder_capability: 5/15）"

---

## 📝 高级配置

### 1. 修改评分标准

编辑 `config.py` 第 81-157 行的 `SYSTEM_PROMPT`，可自定义：
- 各维度的满分分配
- 细分指标的打分区间
- 评级标准（S/A/B/C/D）

### 2. 调整图片分析数量

**当前默认**：最多分析 50 张图片

**修改方式**：
- 在 `utils.py` 第 95 行修改 `[:50]` 为其他值（如 `[:30]`）

### 3. 自定义搜索关键词

编辑 `agent.py` 第 192-200 行的 `_get_search_keywords` 方法，可修改 LLM Prompt 以生成不同的搜索策略

---

## 🤝 贡献与反馈

如遇到问题或有改进建议，请：
1. 查看 [README_BACKEND.md](./README_BACKEND.md) 了解技术架构
2. 提交 Issue 到 GitHub 仓库
3. 发送邮件至项目维护者

---

## 📄 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。

---

## ⚠️ 免责声明

本系统基于 AI 技术生成投资分析报告，**仅供参考**，不构成任何投资建议。用户应：
- 结合自身专业判断进行决策
- 验证 AI 生成内容的准确性
- 自行承担投资风险

---

**最后更新时间**：2026-01-27  
**版本**：v2.0（支持 50 张图片并发分析 + 5 维度 10 指标评分）
